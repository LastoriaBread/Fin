<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>قصة خبزة - ERP</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <style>
        :root {
            /* Modern Palette - Indigo/Violet Theme */
            --primary-color: #4f46e5;       /* Indigo 600 */
            --primary-dark: #3730a3;        /* Indigo 800 */
            --primary-light: #818cf8;       
            --accent-color: #7c3aed;        /* Violet 600 */
            
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            
            --sidebar-gradient-start: #1e1b4b; /* Indigo 950 */
            --sidebar-gradient-end: #312e81;   /* Indigo 900 */
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --card-radius: 16px;
            
            /* Print Colors */
            --print-primary: #1e3a8a; 
            --print-header-bg: #eff6ff;
            --print-border: #cbd5e1; /* Softer border for print */
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden; /* يمنع السكرول العرضي */
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI ENHANCEMENTS --- */
        
        .card, .stats-card, .custom-table-container, .auth-box {
            background: var(--bg-card);
            border: none !important;
            border-radius: var(--card-radius) !important;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Inputs & Form Controls */
        .form-control, .form-select, .select2-selection {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0 !important;
            border-radius: 12px !important;
            padding: 10px 15px;
            font-weight: 600;
            color: #334155;
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            background-color: #fff;
        }

        /* --- Buttons Styling & Glow Effects --- */
        .btn {
            border-radius: 10px !important;
            padding: 10px 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all 0.3s ease; /* تنعيم الحركة */
            border: none !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn:active { transform: scale(0.95); }

        /* Primary Button Glow */
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); }
        .btn-primary:hover { 
            background: linear-gradient(135deg, var(--primary-dark), var(--accent-color)); 
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.7) !important; /* Indigo Glow */
            transform: translateY(-2px);
        }

        /* Success Button Glow */
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-success:hover {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.7) !important; /* Green Glow */
            transform: translateY(-2px);
        }

        /* Danger Button Glow */
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .btn-danger:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.7) !important; /* Red Glow */
            transform: translateY(-2px);
        }

        /* Warning Button Glow */
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-warning:hover {
            color: white;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.7) !important; /* Orange Glow */
            transform: translateY(-2px);
        }

        /* Outline Button Glow */
        .btn-outline-primary { background: transparent; border: 2px solid var(--primary-color) !important; color: var(--primary-color); box-shadow: none; }
        .btn-outline-primary:hover { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.5) !important; 
            transform: translateY(-2px);
        }

        /* Sidebar Styling */
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, var(--sidebar-gradient-start) 0%, var(--sidebar-gradient-end) 100%);
            color: white;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            position: fixed; right: 0; top: 0; width: 270px; z-index: 1050; transition: 0.3s;
            border-left: none !important;
        }

        .sidebar-brand { padding: 30px 20px; text-align: center; background: rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* --- Sidebar Menu Glow Effects (Rotating Colors) --- */
        .nav-link { 
            color: #e0e7ff; 
            padding: 14px 25px; 
            margin: 8px 15px; 
            border-radius: 12px; 
            font-weight: 600; 
            transition: all 0.3s ease-in-out; 
            display: flex; 
            align-items: center; 
            border: 1px solid transparent !important; 
            opacity: 0.9; 
        }
        .nav-link i { margin-left: 15px; width: 25px; text-align: center; font-size: 1.1rem; }
        
        /* Color 1: Indigo/Pink (Items 1, 4, 7...) */
        .nav-item:nth-child(3n+1) .nav-link:hover, .nav-item:nth-child(3n+1) .nav-link.active {
            background: linear-gradient(135deg, #6366f1, #d946ef) !important;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.6);
            color: white;
            transform: translateX(-5px);
            opacity: 1;
        }
        
        /* Color 2: Blue/Cyan (Items 2, 5, 8...) */
        .nav-item:nth-child(3n+2) .nav-link:hover, .nav-item:nth-child(3n+2) .nav-link.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4) !important;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.6);
            color: white;
            transform: translateX(-5px);
            opacity: 1;
        }

        /* Color 3: Orange/Red (Items 3, 6, 9...) */
        .nav-item:nth-child(3n+3) .nav-link:hover, .nav-item:nth-child(3n+3) .nav-link.active {
            background: linear-gradient(135deg, #f59e0b, #f43f5e) !important;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.6);
            color: white;
            transform: translateX(-5px);
            opacity: 1;
        }

        /* Main Content */
        .main-content { margin-right: 270px; padding: 40px; transition: 0.3s; }

        /* Dashboard Stats Cards */
        .stats-card { padding: 25px; position: relative; overflow: hidden; border: none !important; color: white; margin-bottom: 20px; cursor: default; }
        .stats-card h3 { font-weight: 800; font-size: 2rem; margin-top: 10px; color: white !important; font-family: 'Segoe UI', sans-serif; }
        .stats-card p { font-size: 1rem; font-weight: 500; opacity: 0.9; color: white !important; }
        
        .stats-card.sales { background: linear-gradient(135deg, #4f46e5, #3730a3); }
        .stats-card.received { background: linear-gradient(135deg, #10b981, #047857); }
        .stats-card.purchases { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .stats-card.net { background: linear-gradient(135deg, #f59e0b, #b45309); }
        .stats-card.dark { background: linear-gradient(135deg, #1e293b, #0f172a); }
        
        .stats-card .icon-box { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 12px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .stats-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }

        /* Table Styling */
        .custom-table-container { padding: 20px; border: 1px solid #e2e8f0 !important; }
        .table { margin-bottom: 0; }
        
        .table thead th { 
            background-color: #f1f5f9; 
            color: #475569; 
            font-weight: 800; 
            border-bottom: 2px solid #e2e8f0 !important; 
            white-space: nowrap; 
            padding: 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table tbody td { 
            padding: 12px 15px; 
            vertical-align: middle; 
            border: none;
            color: #334155;
            font-weight: 500;
        }

        .table tbody tr:nth-of-type(odd) { background-color: #ffffff; }
        .table tbody tr:nth-of-type(even) { background-color: rgba(79, 70, 229, 0.04); }
        
        .table-hover tbody tr:hover { background-color: rgba(79, 70, 229, 0.1) !important; transition: background-color 0.2s; }

        .search-box-container { position: relative; max-width: 400px; margin-bottom: 20px; width: 100%; }
        .search-box-container i { position: absolute; left: 15px; top: 12px; color: var(--primary-color); }
        .search-box-container input { padding-left: 45px; border-radius: 12px; height: 45px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        /* Auth Screen */
        #authSection { 
            background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%); 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            position: relative;
            overflow: hidden; 
        }
        #authSection::before { content: ''; position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        #authSection::after { content: ''; position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .auth-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid rgba(255,255,255,0.5) !important; z-index: 2; }

        /* Modals */
        .modal-content { border-radius: 20px; border: none !important; }
        .modal-header { border-bottom: 1px solid #f1f5f9; padding: 20px 30px; border-radius: 20px 20px 0 0; }
        .modal-body { padding: 30px; }
        .modal-footer { border-top: 1px solid #f1f5f9; padding: 20px 30px; }

        /* --- GLOW EFFECT FOR ITEMS --- */
        .item-glow-container .select2-selection {
            transition: all 0.3s ease-in-out;
        }
        
        .item-glow-container:hover .select2-selection {
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6) !important;
            border-color: var(--primary-color) !important;
            transform: scale(1.01);
            z-index: 50;
        }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 20px; padding-top: 80px; width: auto; }
            .col-md-3, .col-md-4, .col-md-6 { margin-bottom: 15px; width: 100%; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .modal-body { padding: 15px; }
            .modal-header { padding: 15px; }
            .btn { width: 100%; margin-bottom: 5px; padding: 12px; }
            .form-control, .form-select { height: auto; padding: 12px; }
            .search-box-container { max-width: 100%; }
            #invLines input, #invLines select { font-size: 14px; padding: 5px; }
            .d-flex.justify-content-between { flex-direction: column; gap: 10px; align-items: stretch; }
            .d-flex.justify-content-between > * { width: 100%; text-align: center; }
        }
        
        .mobile-toggle { background: var(--primary-color); color: white; border: none !important; border-radius: 12px; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); display: none; position: fixed; top: 15px; left: 15px; z-index: 1060; align-items: center; justify-content: center; }
        @media (max-width: 768px) { .mobile-toggle { display: flex; } }
        .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1040; backdrop-filter: blur(2px); }

        .badge { padding: 8px 12px; border-radius: 8px; font-weight: 700; }
        .badge-soft-success { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0 !important; }
        .badge-soft-danger { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca !important; }
        .badge-soft-warning { background-color: #fef3c7; color: #b45309; border: 1px solid #fde68a !important; }

        /* --- MODERN PRINT STYLES --- */
        @media print {
            .sidebar, .no-print, .btn, .modal, .toast-container, .mobile-toggle, .overlay, .main-content > div:not(#printArea) { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; width: 100% !important; background: white; }
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            @page { size: A4; margin: 0; }

            #printArea { display: block !important; width: 100%; background: white; font-family: 'Cairo', sans-serif; color: #000; padding: 10mm; box-sizing: border-box; }
            
            /* Header */
            .inv-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 20px; border-bottom: 2px solid var(--print-primary) !important; margin-bottom: 25px; }
            .inv-company-info { text-align: right; width: 35%; }
            .inv-logo-area { text-align: center; width: 30%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
            .inv-qr-area { text-align: left; width: 35%; display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
            
            .company-name { font-size: 20px; font-weight: 800; color: var(--print-primary); margin-bottom: 5px; }
            .company-detail { font-size: 11px; margin-bottom: 3px; color: #555; }
            .doc-title { color: var(--print-primary); font-weight: 800; font-size: 18px; margin-bottom: 10px; border: 2px solid var(--print-primary) !important; padding: 4px 15px; border-radius: 6px; display: inline-block; background: var(--print-header-bg); }

            /* Meta Boxes */
            .inv-meta-grid { display: flex; gap: 20px; margin-bottom: 25px; }
            .meta-box { flex: 1; border: 1px solid #e2e8f0 !important; border-radius: 8px; overflow: hidden; background: #fff; } 
            .meta-header { background-color: var(--print-header-bg); padding: 8px 12px; font-size: 12px; font-weight: 700; color: var(--print-primary); border-bottom: 1px solid #e2e8f0 !important; }
            .meta-content { padding: 10px 12px; }
            .meta-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; }
            .meta-label { color: #64748b; font-weight: 600; }
            .meta-val { font-weight: 700; color: #1e293b; font-family: 'Segoe UI', sans-serif; }

            /* Table */
            .table-wrapper { flex-grow: 1; margin-bottom: 20px; }
            .inv-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; table-layout: fixed; border: 1px solid #cbd5e1 !important; border-radius: 8px; overflow: hidden; }
            .inv-table th { background-color: var(--print-primary) !important; color: white !important; padding: 10px 8px; text-align: center; font-weight: bold; border-bottom: 1px solid #cbd5e1 !important; }
            .inv-table td { border-bottom: 1px solid #e2e8f0 !important; padding: 8px; color: #334155; border-left: 1px solid #f1f5f9; }
            .inv-table tr:last-child td { border-bottom: none; }
            .inv-table td:first-child { border-left: none; }
            
            .num-cell { text-align: right; font-family: 'Segoe UI', sans-serif; font-weight: 600; font-variant-numeric: tabular-nums; direction: ltr; padding-right: 12px !important; }
            .center-cell { text-align: center; }
            .inv-table tr:nth-child(even) { background-color: #f8fafc; }
            
            /* Footer & Totals */
            .inv-footer { margin-top: 10px; page-break-inside: avoid; }
            .totals-container { display: flex; justify-content: flex-end; gap: 20px; align-items: flex-start; }
            .notes-section { flex: 1; font-size: 10px; color: #777; padding-top: 10px; }
            
            /* --- IMPROVED MODERN TOTALS BOX --- */
            .totals-box { 
                width: 340px; 
                background: #ffffff !important; 
                border-radius: 12px;
                border: 1px solid #e2e8f0 !important;
                overflow: hidden;
                box-shadow: none;
            }
            
            .t-row { 
                display: flex; 
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px; 
                border-bottom: 1px solid #f1f5f9 !important;
                background: #ffffff;
            }
            
            .t-label { 
                font-weight: 600;    
                color: #64748b !important;
                font-size: 11px;
            }
            
            .t-val { 
                text-align: right; 
                font-weight: 700 !important;    
                color: #1e293b !important;         
                font-family: 'Segoe UI', sans-serif; 
                direction: ltr; 
                font-size: 12px;
            }
            
            /* Final Total - Modern Highlight */
            .t-final { 
                background-color: var(--print-primary) !important; /* Blue Background */
                color: white !important;
                border-top: none !important;
                padding: 15px;
            }
            .t-final .t-label { 
                color: rgba(255,255,255,0.9) !important; 
                font-size: 13px;
                font-weight: 700;
            }
            .t-final .t-val { 
                color: white !important; 
                font-size: 18px;
                font-weight: 800;
            }
            
            body { zoom: 95%; } 

            /* --- HIGH CONTRAST PRINT MODE --- */
            body.print-high-contrast * {
                color: #000000 !important;
                border-color: #000000 !important;
                text-shadow: none !important;
            }

            body.print-high-contrast .inv-header,
            body.print-high-contrast .meta-header,
            body.print-high-contrast .inv-table th,
            body.print-high-contrast .t-final,
            body.print-high-contrast .doc-title {
                background-color: #ffffff !important;
                background: none !important;
                color: #000000 !important;
            }

            body.print-high-contrast .inv-table th,
            body.print-high-contrast .inv-table td,
            body.print-high-contrast .meta-box,
            body.print-high-contrast .totals-box,
            body.print-high-contrast .t-row,
            body.print-high-contrast .doc-title {
                border: 1px solid #000000 !important;
            }
            
            body.print-high-contrast .inv-table th {
                border-bottom: 2px solid #000000 !important;
            }

            /* FIX: Ensure all text in High Contrast is Black, including totals */
            body.print-high-contrast .company-name,
            body.print-high-contrast .meta-label,
            body.print-high-contrast .t-label,
            body.print-high-contrast .company-detail,
            body.print-high-contrast .notes-section,
            body.print-high-contrast .t-final .t-label,
            body.print-high-contrast .t-final .t-val {
                color: #000000 !important;
                opacity: 1 !important;
            }

            /* Add top border to final total to separate it in B&W mode */
            body.print-high-contrast .t-final {
                border-top: 2px solid #000000 !important;
            }
        }

        /* --- GLOW EFFECT FOR DROPDOWN ITEMS --- */
        .select2-results__option--highlighted[aria-selected] {
            color: white !important;
            font-weight: bold;
            transition: all 0.1s ease-in-out;
            border-radius: 10px;
            margin: 3px 0;
            transform: translateX(-5px);
        }
        /* اللون الأول: بنفسجي */
        .select2-results__option:nth-child(3n+1).select2-results__option--highlighted[aria-selected] {
            background: linear-gradient(135deg, #6366f1, #d946ef) !important;
            box-shadow: 0 0 15px rgba(217, 70, 239, 0.6);
        }
        /* اللون الثاني: أزرق سماوي */
        .select2-results__option:nth-child(3n+2).select2-results__option--highlighted[aria-selected] {
            background: linear-gradient(135deg, #3b82f6, #06b6d4) !important;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.6);
        }
        /* اللون الثالث: برتقالي ناري */
        .select2-results__option:nth-child(3n+3).select2-results__option--highlighted[aria-selected] {
            background: linear-gradient(135deg, #f59e0b, #f43f5e) !important;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.6);
        }
        /* تحسين شكل القائمة */
        .select2-dropdown {
            border: 0 !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
            border-radius: 16px !important;
            padding: 10px !important;
            overflow: hidden;
        }

        /* === FIX: HIDE HORIZONTAL SCROLLBAR IN DROPDOWN === */
        .select2-results__options {
            overflow-x: hidden !important;
        }

    </style>
</head>
<body>

<button class="mobile-toggle no-print" onclick="toggleSidebar()">
    <i class="fa fa-bars fa-lg"></i>
</button>
<div class="overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<div id="authSection">
    <div class="auth-box text-center">
        <div class="mb-5">
            <div style="width: 70px; height: 70px; background: var(--primary-color); border-radius: 16px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);">
                <i class="fa-solid fa-chart-pie fa-2x text-white"></i>
            </div>
            <h3 class="fw-bold text-dark">قصة خبزة - ERP</h3>
            <p class="text-muted small">منصة إدارة الأعمال المتكاملة</p>
        </div>
        
        <div id="loginForm">
            <div class="form-floating mb-3">
                <input type="email" id="loginEmail" class="form-control" placeholder="name@example.com">
                <label for="loginEmail">البريد الإلكتروني</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" id="loginPass" class="form-control" placeholder="Password">
                <label for="loginPass">كلمة المرور</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100 py-3 mb-3 shadow-sm">
                تسجيل الدخول <i class="fa-solid fa-arrow-left me-2"></i>
            </button>
            <a href="#" onclick="toggleAuth('register')" class="text-decoration-none small text-primary fw-bold">تسجيل حساب شركة جديد؟</a>
        </div>

        <div id="registerForm" style="display:none;">
            <div class="row g-2 text-end">
                <div class="col-12 mb-2"><input type="email" id="regEmail" class="form-control" placeholder="البريد الإلكتروني"></div>
                <div class="col-12 mb-2"><input type="password" id="regPass" class="form-control" placeholder="كلمة المرور"></div>
                <div class="col-12 mb-2"><input type="text" id="regBusNameAr" class="form-control" placeholder="اسم الشركة"></div>
                <div class="col-12 mb-3"><input type="text" id="regVAT" class="form-control" placeholder="الرقم الضريبي"></div>
            </div>
            <button onclick="register()" class="btn btn-success w-100 py-3 fw-bold shadow-sm">إنشاء حساب جديد</button>
            <p class="mt-3"><a href="#" onclick="toggleAuth('login')" class="text-decoration-none small text-muted">لديك حساب بالفعل؟ تسجيل الدخول</a></p>
        </div>
        <div id="authError" class="text-danger mt-3 small fw-bold"></div>
    </div>
</div>

<div id="appSection" style="display:none;">
    
    <div class="sidebar no-print" id="mainSidebar">
        <div class="sidebar-brand">
            <h5 class="mb-0 fw-bold" id="sidebarBusName">قصة خبزة - ERP</h5>
            <small class="text-white-50" style="font-size: 11px; letter-spacing: 0.5px;" id="sidebarUserEmail"></small>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fa-solid fa-layer-group"></i> الرئيسية</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('invoices')"><i class="fa-solid fa-file-invoice-dollar"></i> الفواتير</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('items')"><i class="fa-solid fa-box-open"></i> المنتجات</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('contacts')"><i class="fa-solid fa-users-line"></i> العملاء والموردين</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('manualEntries')"><i class="fa-solid fa-money-bill-transfer"></i> قيود يدوية</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('productReports')"><i class="fa-solid fa-chart-column"></i> تقرير الأصناف المباعة</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fa-solid fa-chart-pie"></i> كشف الحساب</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showSection('settings')"><i class="fa-solid fa-sliders"></i> إعدادات الشركة</a></li>
        </ul>
        <div class="mt-auto p-4">
            <button onclick="logout()" class="btn btn-danger w-100 btn-sm bg-gradient border-0"><i class="fa-solid fa-right-from-bracket ms-2"></i> خروج</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="section-content">
            <h3 class="fw-bold mb-4 text-dark"><i class="fa-regular fa-chart-bar text-primary me-2"></i> لوحة المعلومات</h3>
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="stats-card sales">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p>إجمالي المبيعات</p>
                                <h3 id="dashSales">0.00</h3>
                            </div>
                            <div class="icon-box"><i class="fa-solid fa-wallet"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card received">
                         <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p>المقبوضات</p>
                                <h3 id="dashReceived">0.00</h3>
                            </div>
                            <div class="icon-box"><i class="fa-solid fa-money-bill-wave"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card purchases">
                         <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p>المشتريات</p>
                                <h3 id="dashPurchases">0.00</h3>
                            </div>
                            <div class="icon-box"><i class="fa-solid fa-cart-shopping"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card net">
                         <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p>صافي الموقف</p>
                                <h3 id="dashNet">0.00</h3>
                            </div>
                            <div class="icon-box"><i class="fa-solid fa-scale-balanced"></i></div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="row g-4">
                <div class="col-md-4">
                    <button onclick="showSection('invoices'); openInvoiceModal()" class="btn btn-outline-primary w-100 p-4 h-100 border-2 fw-bold d-flex flex-column align-items-center justify-content-center gap-2">
                        <i class="fa fa-plus-circle fa-3x"></i> 
                        <span class="fs-5">فاتورة جديدة</span>
                    </button>
                </div>
                <div class="col-md-4">
                    <button onclick="showSection('manualEntries')" class="btn btn-outline-primary w-100 p-4 h-100 border-2 fw-bold d-flex flex-column align-items-center justify-content-center gap-2" style="border-color: #10b981 !important; color: #10b981;">
                        <i class="fa fa-hand-holding-dollar fa-3x"></i> 
                        <span class="fs-5">تسجيل دفعة</span>
                    </button>
                </div>
                <div class="col-md-4">
                    <button onclick="showSection('contacts'); openContactModal()" class="btn btn-outline-primary w-100 p-4 h-100 border-2 fw-bold d-flex flex-column align-items-center justify-content-center gap-2" style="border-color: #6366f1 !important; color: #6366f1;">
                        <i class="fa fa-user-plus fa-3x"></i> 
                        <span class="fs-5">عميل جديد</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="invoices" class="section-content" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">الفواتير</h3>
                <div>
                    <button class="btn btn-success me-2 text-white" onclick="exportToExcel('invoicesTableRaw', 'Invoices_Report')"><i class="fa fa-file-excel me-2"></i> Excel</button>
                    <button class="btn btn-primary" onclick="openInvoiceModal()"><i class="fa fa-plus ms-2"></i> إنشاء فاتورة</button>
                </div>
            </div>
            <div class="search-box-container">
                <i class="fa fa-search"></i>
                <input type="text" class="form-control" placeholder="بحث برقم الفاتورة أو اسم العميل..." onkeyup="searchTable(this, 'invoicesTable')">
            </div>
            <div class="custom-table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="invoicesTableRaw">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل/المورد</th>
                                <th>النوع</th>
                                <th>الإجمالي</th>
                                <th class="no-print">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="items" class="section-content" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">الأصناف والمنتجات</h3>
                <div>
                     <button class="btn btn-success me-2 text-white" onclick="exportToExcel('itemsTableRaw', 'Items_List')"><i class="fa fa-file-excel me-2"></i> Excel</button>
                     <button class="btn btn-primary" onclick="openItemModal()"><i class="fa fa-plus ms-2"></i> صنف جديد</button>
                </div>
            </div>
            <div class="search-box-container">
                <i class="fa fa-search"></i>
                <input type="text" class="form-control" placeholder="بحث باسم الصنف أو الكود..." onkeyup="searchTable(this, 'itemsTable')">
            </div>
            <div class="custom-table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="itemsTableRaw">
                        <thead>
                            <tr>
                                <th>الكود</th>
                                <th>اسم الصنف (عربي)</th>
                                <th>Name (En)</th>
                                <th>السعر</th>
                                <th>مخصص لـ</th>
                                <th class="no-print">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="contacts" class="section-content" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">العملاء والموردين</h3>
                <div>
                     <button class="btn btn-success me-2 text-white" onclick="exportToExcel('contactsTableRaw', 'Contacts_List')"><i class="fa fa-file-excel me-2"></i> Excel</button>
                     <button class="btn btn-primary" onclick="openContactModal()"><i class="fa fa-plus ms-2"></i> إضافة جديد</button>
                </div>
            </div>
            <div class="search-box-container">
                <i class="fa fa-search"></i>
                <input type="text" class="form-control" placeholder="بحث باسم العميل، الهاتف أو الكود..." onkeyup="searchTable(this, 'contactsTable')">
            </div>
            <div class="custom-table-container">
                <div class="table-responsive">
                    <table class="table table-hover" id="contactsTableRaw">
                        <thead><tr><th>الكود</th><th>الاسم</th><th>النوع</th><th>الهاتف</th><th>الرصيد</th><th class="no-print">إجراءات</th></tr></thead>
                        <tbody id="contactsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="manualEntries" class="section-content" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark">القيود اليدوية والسندات</h3>
            </div>
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card p-4">
                        <h5 class="mb-4 text-primary fw-bold"><i class="fa fa-pen-nib me-2"></i> تسجيل حركة جديدة</h5>
                        <select id="payContact" class="form-select mb-3"></select>
                        <select id="payType" class="form-select mb-3">
                            <option value="Receipt">سند قبض (من عميل)</option>
                            <option value="Payment">سند صرف (لمورد)</option>
                            <option value="Adjustment">قيد تسوية (Direct Adjustment)</option>
                        </select>
                        <input type="date" id="payDate" class="form-control mb-3">
                        <input type="text" inputmode="decimal" id="payAmount" class="form-control mb-3 fw-bold text-center text-primary" placeholder="المبلغ 0.00" style="font-size: 1.2rem;">
                        <div class="form-text text-muted mb-3" style="font-size: 11px;">في قيد التسوية: استخدم رقم سالب للخصم.</div>
                        <input type="text" id="payNote" class="form-control mb-4" placeholder="ملاحظات (شرح القيد)">
                        <button class="btn btn-success w-100 fw-bold shadow-sm" onclick="savePayment()">حفظ الحركة</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="custom-table-container">
                         <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead><tr><th>#</th><th>التاريخ</th><th>الطرف</th><th>النوع</th><th>المبلغ</th><th>إجراءات</th></tr></thead>
                                <tbody id="paymentsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="productReports" class="section-content" style="display:none;">
            <h3 class="fw-bold mb-4 text-dark">تقرير مبيعات الأصناف (تفصيلي)</h3>
            <div class="card p-4 mb-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">من تاريخ</label>
                        <input type="date" id="repProdFrom" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small text-muted">إلى تاريخ</label>
                        <input type="date" id="repProdTo" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 fw-bold" onclick="generateProductSales()">عرض التقرير</button>
                    </div>
                </div>
            </div>
            <div class="custom-table-container">
                <button class="btn btn-success mb-3 text-white" onclick="exportToExcel('prodSalesTableRaw', 'Detailed_Product_Sales')"><i class="fa fa-file-excel me-2"></i> Excel</button>
                <div class="table-responsive">
                    <table class="table table-bordered border-secondary" id="prodSalesTableRaw">
                        <thead>
                            <tr class="table-dark">
                                <th width="15%">كود الصنف</th>
                                <th width="30%">اسم الصنف / العميل</th>
                                <th width="20%">الكمية</th>
                                <th width="20%">القيمة الإجمالية</th>
                            </tr>
                        </thead>
                        <tbody id="prodSalesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="reports" class="section-content" style="display:none;">
            <h3 class="fw-bold mb-4 text-dark">كشف الحساب (SOA)</h3>
            <div class="card p-4 mb-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4"><label class="form-label fw-bold small text-muted">العميل</label><select id="repContact" class="form-select"></select></div>
                    <div class="col-md-3"><label class="form-label fw-bold small text-muted">من تاريخ</label><input type="date" id="repFrom" class="form-control"></div>
                    <div class="col-md-3"><button class="btn btn-primary w-100 fw-bold" onclick="generateSOA()">عرض التقرير</button></div>
                </div>
            </div>
            <div id="soaResult" class="custom-table-container" style="display:none;">
                <div class="d-flex justify-content-between mb-3 align-items-center border-bottom pb-3">
                    <h5 class="fw-bold text-primary mb-0">كشف حساب: <span id="soaName" class="text-dark"></span></h5>
                    <div>
                        <button class="btn btn-sm btn-success me-2 text-white" onclick="exportToExcel('soaTableRaw', 'Statement_Account')"><i class="fa fa-file-excel"></i> Excel</button>
                        <button class="btn btn-sm btn-outline-dark" onclick="printSOA()"><i class="fa fa-print"></i> طباعة</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered text-center" id="soaTableRaw">
                        <thead class="table-light"><tr><th>التاريخ</th><th>البيان</th><th>مدين (عليه)</th><th>دائن (له)</th><th>الرصيد</th></tr></thead>
                        <tbody id="soaTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="section-content" style="display:none;">
            <h3 class="fw-bold mb-4 text-dark">إعدادات الشركة</h3>
            <div class="card p-5">
                <div class="row g-4">
                    <div class="col-12 mb-3 text-center border-bottom pb-4">
                        <img id="logoPreview" src="" style="max-height: 100px; display:none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" class="mb-3">
                        <br>
                        <label class="btn btn-outline-primary btn-sm">
                            <i class="fa fa-upload me-2"></i> رفع شعار الشركة (Logo)
                            <input type="file" id="logoInput" class="d-none" accept="image/*">
                        </label>
                    </div>

                    <div class="col-md-6"><label class="form-label fw-bold text-muted small">اسم الشركة (عربي)</label><input type="text" id="setBusNameAr" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label fw-bold text-muted small">Company Name (En)</label><input type="text" id="setBusNameEn" class="form-control"></div>
                    <div class="col-md-12"><label class="form-label fw-bold text-muted small">العنوان</label><input type="text" id="setAddr" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label fw-bold text-muted small">الرقم الضريبي (VAT)</label><input type="text" id="setVAT" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label fw-bold text-primary small">السجل التجاري (CR)</label><input type="text" id="setCR" class="form-control" placeholder="رقم السجل"></div>
                    <div class="col-md-4"><label class="form-label fw-bold text-muted small">رقم الهاتف</label><input type="text" id="setPhone" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label fw-bold text-muted small">البريد الإلكتروني</label><input type="text" id="setEmail" class="form-control"></div>
                    <div class="col-12 text-start mt-4 border-top pt-3"><button class="btn btn-primary px-5 fw-bold shadow" onclick="saveSettings()">حفظ الإعدادات</button></div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="invoiceModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-gradient bg-primary text-white border-0">
                <h5 class="modal-title fw-bold"><i class="fa fa-file-invoice me-2"></i> فاتورة جديدة</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                 <div class="row mb-4 bg-white p-3 rounded-4 shadow-sm mx-1 align-items-center border">
                    <div class="col-md-6">
                        <label class="small text-muted mb-1 fw-bold">استيراد من فاتورة سابقة</label>
                        <div class="input-group">
                            <input type="text" id="importRef" class="form-control border-end-0" placeholder="رقم الفاتورة (مثال: INV-1005)">
                            <button class="btn btn-outline-primary fw-bold px-4" onclick="importInvoice()">استيراد</button>
                        </div>
                    </div>
                </div>
                <div class="card p-4 mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="small text-muted fw-bold mb-1">النوع</label>
                            <select id="invType" class="form-select bg-white">
                                <option value="Sales Invoice">فاتورة مبيعات</option>
                                <option value="Purchase Invoice">فاتورة مشتريات</option>
                                <option value="Credit Note">مرتجع / إشعار دائن</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                             <label class="small text-muted fw-bold mb-1">اسم العميل/المورد</label>
                             <select id="invContactNameSelect" class="form-select select2" style="width: 100%;"></select>
                             <select id="invBranchAddr" class="form-select mt-2 text-primary fw-bold shadow-sm" style="display:none; font-size: 0.8rem;"></select>
                        </div>
                        <div class="col-md-2">
                             <label class="small text-muted fw-bold mb-1">الكود</label>
                             <select id="invContactCodeSelect" class="form-select select2" style="width: 100%;"></select>
                        </div>
                         <div class="col-md-1 d-flex align-items-end">
                             <button class="btn btn-primary w-100" onclick="openContactModal()" title="إضافة عميل جديد"><i class="fa fa-plus"></i></button>
                         </div>

                        <div class="col-md-2"><label class="small text-muted fw-bold mb-1">التاريخ</label><input type="date" id="invDate" class="form-control bg-white"></div>
                        <div class="col-md-1"><label class="small text-muted fw-bold mb-1">الرقم</label><input type="text" id="invRef" class="form-control bg-light fw-bold text-primary text-center" readonly style="font-size: 0.9rem;"></div>
                    </div>
                </div>
                
                <div class="card overflow-hidden mb-4 border shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 align-middle" style="min-width: 600px;">
                            <thead class="bg-light text-center" style="font-size: 0.9rem;">
                                <tr>
                                    <th width="15%">كود الصنف</th> 
                                    <th width="25%">الصنف</th>
                                    <th width="15%">السعر</th>
                                    <th width="10%">الكمية</th>
                                    <th width="15%">ضريبة (15%)</th>
                                    <th width="15%">الإجمالي</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="invLines" class="bg-white"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-light d-flex justify-content-between border-top">
                        <button class="btn btn-sm btn-outline-primary fw-bold" onclick="addInvLine()"><i class="fa fa-plus me-1"></i> إضافة سطر</button>
                        <button class="btn btn-sm btn-outline-success fw-bold" onclick="openItemModal()"><i class="fa fa-box-open me-1"></i> إضافة صنف جديد</button>
                    </div>
                </div>

                <div class="row justify-content-end">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small fw-bold">ملاحظات داخلية (تظهر في كشف الحساب فقط)</label>
                        <input type="text" id="invInternalNote" class="form-control" placeholder="أدخل أي ملاحظات هنا...">
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 bg-white border">
                            <div class="d-flex justify-content-between mb-2"><span class="text-muted fw-bold">المجموع قبل الضريبة:</span><span id="invSubTotal" class="fw-bold">0.00</span></div>
                            <div class="d-flex justify-content-between mb-2"><span class="text-muted fw-bold">ضريبة القيمة المضافة:</span><span id="invTax" class="text-danger fw-bold">0.00</span></div>
                            <div class="border-top pt-3 mt-2 d-flex justify-content-between align-items-center">
                                <span class="h6 fw-bold mb-0">الإجمالي النهائي:</span>
                                <span id="invGrandTotal" class="h4 text-primary fw-bold mb-0">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0 bg-light">
                <button class="btn btn-light text-muted fw-bold" data-bs-dismiss="modal">إلغاء</button>
                <button class="btn btn-success px-5 fw-bold shadow" onclick="saveInvoice()">حفظ الفاتورة</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header bg-light"><h5 class="modal-title fw-bold" id="itemModalTitle">إضافة صنف</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <input type="hidden" id="itemFirebaseKey">
                <label class="form-label text-muted small fw-bold">كود الصنف</label>
                <input id="itemCode" class="form-control bg-light mb-3 text-center fw-bold" readonly>
                <label class="form-label text-muted small fw-bold">الاسم</label>
                <input id="itemNameAr" class="form-control mb-3" placeholder="اسم الصنف (عربي)">
                <input id="itemNameEn" class="form-control mb-3" placeholder="Name (En)">
                
                <label class="form-label text-muted small fw-bold">سعر البيع الافتراضي</label>
                <input id="itemPrice" type="number" class="form-control mb-3 fw-bold text-primary" placeholder="0.00">
                
                <hr class="my-3">
                <label class="form-label text-muted small fw-bold text-success"><i class="fa fa-link"></i> ربط بعميل محدد (سعر خاص)</label>
                <select id="itemLinkedContact" class="form-select mb-2"></select>
                <input id="itemSpecialPrice" type="number" class="form-control mb-3 fw-bold text-success" placeholder="السعر الخاص لهذا العميل">
                
                <button class="btn btn-primary w-100 fw-bold mt-2" onclick="saveItem()">حفظ البيانات</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header bg-light"><h5 class="modal-title fw-bold" id="contactModalTitle">عميل / مورد جديد</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4">
                <input type="hidden" id="contactFirebaseKey">
                
                <div class="row g-3">
                    <div class="col-md-4"><label class="form-label text-muted small fw-bold">النوع</label><select id="cType" class="form-select" onchange="generateContactCode()"><option value="Client">عميل</option><option value="Vendor">مورد</option></select></div>
                    <div class="col-md-4"><label class="form-label text-muted small fw-bold">الكود</label><input id="cCode" class="form-control bg-light text-center fw-bold" readonly></div>
                    <div class="col-md-4"><label class="form-label text-muted small fw-bold">الاسم</label><input id="cName" class="form-control" placeholder="الاسم التجاري"></div>
                    <div class="col-md-6"><label class="form-label text-muted small fw-bold">الهاتف</label><input id="cPhone" class="form-control" placeholder="05xxxxxxxx"></div>
                    <div class="col-md-6"><label class="form-label text-muted small fw-bold">البريد</label><input id="cEmail" class="form-control" placeholder="email@domain.com"></div>
                    <div class="col-md-12"><label class="form-label text-muted small fw-bold">العنوان الرئيسي</label><input id="cAddr" class="form-control" placeholder="المدينة، الحي، الشارع"></div>
                    <div class="col-md-6"><label class="form-label text-muted small fw-bold">الرقم الضريبي</label><input id="cTax" class="form-control" placeholder="3xxxxxxxxxxxxxx"></div>
                    <div class="col-md-6"><label class="form-label text-muted small fw-bold">السجل التجاري</label><input id="cCR" class="form-control" placeholder="10xxxxxxxx"></div>
                    
                    <div class="col-12 mt-4 border-top pt-3">
                        <h6 class="fw-bold text-primary mb-3"><i class="fa fa-map-marker-alt me-2"></i> فروع / عناوين إضافية</h6>
                        <div id="cBranchesContainer" class="mb-2"></div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="addBranchInput()">+ إضافة فرع</button>
                    </div>
                </div>
                <button class="btn btn-primary w-100 mt-4 fw-bold py-2 shadow-sm" onclick="saveContact()">حفظ السجل</button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 start-0 p-3">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0 shadow-lg">
        <div class="d-flex"><div class="toast-body fw-bold px-4" id="toastMsg">تم الحفظ بنجاح</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>
</div>

<div id="printArea" class="d-none" dir="rtl">
    <div class="inv-header">
        <div class="inv-company-info">
            <div class="company-name" id="pCompName">قصة خبزة - ERP</div>
            <div class="company-detail" id="pCompAddr">العنوان</div>
            <div class="company-detail">رقم الجوال: <span id="pCompPhone" dir="ltr"></span></div>
            <div class="company-detail">البريد: <span id="pCompEmail"></span></div>
            <div class="company-detail">الرقم الضريبي: <span id="pCompVat" dir="ltr"></span></div>
            <div class="company-detail">السجل التجاري: <span id="pCompCR" dir="ltr"></span></div>
        </div>
        
        <div class="inv-logo-area">
            <div class="doc-title" id="pDocTitle">فاتورة ضريبية</div>
            <img id="pLogo" src="" style="max-height: 100px; max-width: 100%; display:none;">
        </div>

        <div class="inv-qr-area">
            <div id="qrcode" style="display: inline-block; border: 1px solid #ddd; padding: 2px;"></div>
        </div>
    </div>

    <div class="inv-meta-grid">
        <div class="meta-box">
            <div class="meta-header">بيانات العميل</div>
            <div class="meta-content">
                <div class="meta-row"><span class="meta-label">الاسم:</span> <span class="meta-val" id="pClientName"></span></div>
                <div class="meta-row"><span class="meta-label">العنوان:</span> <span class="meta-val" id="pClientAddr"></span></div>
                <div class="meta-row"><span class="meta-label">الرقم الضريبي:</span> <span class="meta-val" id="pClientTax" dir="ltr"></span></div>
                <div class="meta-row"><span class="meta-label">السجل التجاري:</span> <span class="meta-val" id="pClientCR" dir="ltr"></span></div>
            </div>
        </div>
        <div class="meta-box">
            <div class="meta-header">تفاصيل الفاتورة</div>
            <div class="meta-content">
                <div class="meta-row"><span class="meta-label">رقم الفاتورة:</span> <span class="meta-val" id="pRef" dir="ltr"></span></div>
                <div class="meta-row"><span class="meta-label">التاريخ:</span> <span class="meta-val" id="pDate" dir="ltr"></span></div>
                <div class="meta-row"><span class="meta-label">وقت الإصدار:</span> <span class="meta-val" id="pTime" dir="ltr"></span></div>
            </div>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="inv-table">
            <thead>
                <tr>
                    <th width="12%">رقم الصنف</th>
                    <th width="20%">المنتج / الخدمة</th>
                    <th width="8%">الكمية</th>
                    <th width="10%">سعر الوحدة</th>
                    <th width="12%">المبلغ الخاضع</th>
                    <th width="8%">الضريبة %</th>
                    <th width="10%">قيمة الضريبة</th>
                    <th width="15%">المجموع (شامل)</th>
                </tr>
            </thead>
            <tbody id="pLines"></tbody>
            <tfoot>
                 <tr style="background-color: #f1f5f9; font-weight: bold;">
                    <td colspan="2" style="text-align: left; padding-left: 10px; border-top: 1px solid #cbd5e1 !important;">إجمالي الكميات:</td>
                    <td id="pTotalQty" class="center-cell" style="border-top: 1px solid #cbd5e1 !important;">0</td>
                    <td colspan="5" style="border-top: 1px solid #cbd5e1 !important;"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="inv-footer">
        <div class="totals-container">
            <div class="notes-section"></div>
            <div class="totals-box">
                <div class="t-row">
                    <div class="t-label">إجمالي المبلغ غير شامل الضريبة</div>
                    <div class="t-val" id="pSub">0.00</div>
                </div>
                <div class="t-row">
                    <div class="t-label">ضريبة القيمة المضافة (15%)</div>
                    <div class="t-val" id="pTax">0.00</div>
                </div>
                <div class="t-row t-final">
                    <div class="t-label">صافي المستحق</div>
                    <div class="t-val" id="pTotal">0.00</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAHbrer3tMJenFKv0UwgfhaZDqwD84jgHo",
        authDomain: "accountingdatabase96.firebaseapp.com",
        databaseURL: "https://accountingdatabase96-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "accountingdatabase96",
        storageBucket: "accountingdatabase96.firebasestorage.app",
        messagingSenderId: "381732130416",
        appId: "1:381732130416:web:97bccdb9b30121c685eeb5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let data = { profile: {}, contacts: [], items: [], invoices: [], payments: [] };
    let currentLines = [];

    // --- Helpers ---
    window.getSaudiDateISO = () => {
        const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Riyadh"}));
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    };
    window.getSaudiTimeISO = () => new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Riyadh"})).toISOString();
    
    const formatMoney = (n) => Number(n).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    window.toggleSidebar = () => {
        const s = document.getElementById('mainSidebar');
        const o = document.getElementById('mobileOverlay');
        s.classList.toggle('active');
        o.style.display = s.classList.contains('active') ? 'block' : 'none';
    };

    window.searchTable = (input, tableId) => {
        const filter = input.value.toUpperCase();
        const table = document.getElementById(tableId);
        const tr = table.getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
            let visible = false;
            const tds = tr[i].getElementsByTagName("td");
            for(let j=0; j<tds.length; j++) {
                if (tds[j].textContent.toUpperCase().indexOf(filter) > -1) {
                    visible = true;
                    break;
                }
            }
            tr[i].style.display = visible ? "" : "none";
        }
    };

    // --- ZATCA ---
    function getTLV(tag, value) {
        const utf8Arr = new TextEncoder().encode(String(value));
        const combined = new Uint8Array(2 + utf8Arr.length);
        combined[0] = tag;
        combined[1] = utf8Arr.length;
        combined.set(utf8Arr, 2);
        return combined;
    }
    function generateZatcaBase64(seller, vat, time, total, tax) {
        const b1 = getTLV(1, seller), b2 = getTLV(2, vat), b3 = getTLV(3, time), b4 = getTLV(4, total), b5 = getTLV(5, tax);
        const all = new Uint8Array(b1.length + b2.length + b3.length + b4.length + b5.length);
        let offset = 0;
        [b1, b2, b3, b4, b5].forEach(b => { all.set(b, offset); offset += b.length; });
        return window.btoa(String.fromCharCode(...all));
    }

    // --- Auth & Init ---
    window.toggleAuth = (m) => { document.getElementById('loginForm').style.display = m=='login'?'block':'none'; document.getElementById('registerForm').style.display = m=='register'?'block':'none'; };
    window.login = () => signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(e => document.getElementById('authError').innerText = e.message);
    window.register = () => {
        createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value).then((c) => {
            set(ref(db, `users/${c.user.uid}/profile`), { businessNameAr: document.getElementById('regBusNameAr').value, vat: document.getElementById('regVAT').value });
        }).catch(e => document.getElementById('authError').innerText = e.message);
    };
    window.logout = () => signOut(auth);
    onAuthStateChanged(auth, u => {
        currentUser = u;
        document.getElementById('authSection').style.display = u ? 'none' : 'flex';
        document.getElementById('appSection').style.display = u ? 'block' : 'none';
        if (u) { document.getElementById('sidebarUserEmail').innerText = u.email; initData(u.uid); }
    });

    function initData(uid) {
        onValue(ref(db, `users/${uid}`), s => {
            const v = s.val() || {};
            const contactsMap = v.contacts || {};
            const contactsArr = Object.keys(contactsMap).map(key => ({ ...contactsMap[key], key: key }));

            const itemsMap = v.items || {};
            const itemsArr = Object.keys(itemsMap).map(key => ({ ...itemsMap[key], key: key }));

            const invMap = v.invoices || {};
            const invArr = Object.keys(invMap).map(key => ({ ...invMap[key], key: key }));

            const payMap = v.payments || {};
            const payArr = Object.keys(payMap).map(key => ({ ...payMap[key], key: key }));

            data = {
                profile: v.profile || {},
                contacts: contactsArr,
                items: itemsArr,
                invoices: invArr,
                payments: payArr
            };
            updateUI();
        });
    }

    function getContactBalance(contactId) {
        let balance = 0;
        // Invoices
        data.invoices.filter(i => i.contactId == contactId).forEach(i => {
            if (i.type === 'Sales Invoice') {
                balance += Number(i.total); 
            } else if (i.type === 'Credit Note') {
                balance -= Number(i.total); 
            } else if (i.type === 'Purchase Invoice') {
                balance -= Number(i.total); 
            }
        });
        // Payments / Manual Entries
        data.payments.filter(p => p.contactId == contactId).forEach(p => {
            const amt = Number(p.amount);
            if (p.type === 'Receipt') {
                balance -= amt; // Payment from client reduces their debt
            } else if (p.type === 'Payment') {
                balance += amt; // Payment to vendor reduces our debt (moves negative towards zero)
            } else {
                // Adjustment or Adjustment Reversal: Add directly (negative value reduces debt)
                balance += amt; 
            }
        });
        return balance;
    }

    function updateUI() {
        let sales=0, purchases=0, received=0;
        data.invoices.forEach(i => { if(i.type==='Sales Invoice') sales+=i.total; else if(i.type==='Purchase Invoice') purchases+=i.total; else sales-=i.total; });
        data.payments.forEach(p => { if(p.type==='Receipt') received+=Number(p.amount); });

        document.getElementById('dashSales').innerText = formatMoney(sales);
        document.getElementById('dashPurchases').innerText = formatMoney(purchases);
        document.getElementById('dashReceived').innerText = formatMoney(received);
        document.getElementById('dashNet').innerText = formatMoney(sales-purchases);
        
        document.getElementById('sidebarBusName').innerText = data.profile.businessNameAr || "قصة خبزة - ERP";

        renderInvoicesTable(); renderItemsTable(); renderContactsTable(); renderPaymentsTable(); 
        populateSelects();

        document.getElementById('setBusNameAr').value = data.profile.businessNameAr || '';
        document.getElementById('setBusNameEn').value = data.profile.businessNameEn || '';
        document.getElementById('setAddr').value = data.profile.address || '';
        document.getElementById('setVAT').value = data.profile.vat || '';
        document.getElementById('setCR').value = data.profile.crNumber || ''; 
        document.getElementById('setPhone').value = data.profile.phone || '';
        document.getElementById('setEmail').value = data.profile.email || '';
        if(data.profile.logo) { document.getElementById('logoPreview').src = data.profile.logo; document.getElementById('logoPreview').style.display = 'inline-block'; }
    }

    const showToast = (msg) => { document.getElementById('toastMsg').innerText = msg; new bootstrap.Toast(document.getElementById('liveToast')).show(); };
    window.showSection = (id) => { 
        document.querySelectorAll('.section-content').forEach(e=>e.style.display='none'); 
        document.getElementById(id).style.display='block'; 
        document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); 
        document.getElementById('mainSidebar').classList.remove('active');
        document.getElementById('mobileOverlay').style.display = 'none';
    };
    
    function populateSelects() {
        const placeholder = '<option value="">اختر...</option>';
        const nameOpts = data.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        document.getElementById('payContact').innerHTML = placeholder + nameOpts;
        document.getElementById('repContact').innerHTML = placeholder + nameOpts;
        document.getElementById('itemLinkedContact').innerHTML = '<option value="">-- عام (بدون تخصيص) --</option>' + nameOpts;

        const nameSelect = document.getElementById('invContactNameSelect');
        const codeSelect = document.getElementById('invContactCodeSelect');
        nameSelect.innerHTML = '<option></option>'; 
        codeSelect.innerHTML = '<option></option>'; 

        data.contacts.forEach(c => {
            const opt1 = new Option(c.name, c.id, false, false);
            nameSelect.add(opt1);
            const opt2 = new Option(c.code, c.id, false, false);
            codeSelect.add(opt2);
        });
    }

    $(document).ready(function() {
        $('.select2').select2({ theme: 'bootstrap-5', placeholder: 'اختر...', allowClear: true, dropdownParent: $('#invoiceModal') });
        let isSyncing = false;
        $('#invContactNameSelect').on('change', function() {
            if (isSyncing) return;
            isSyncing = true;
            const val = $(this).val();
            $('#invContactCodeSelect').val(val).trigger('change');
            updateBranchSelect(val);
            renderInvLines();
            isSyncing = false;
        });
        $('#invContactCodeSelect').on('change', function() {
            if (isSyncing) return;
            isSyncing = true;
            const val = $(this).val();
            $('#invContactNameSelect').val(val).trigger('change');
            isSyncing = false;
        });
    });

    function updateBranchSelect(contactId) {
        const branchSelect = document.getElementById('invBranchAddr');
        branchSelect.innerHTML = '';
        branchSelect.style.display = 'none';
        if (!contactId) return;
        const c = data.contacts.find(x => x.id == contactId);
        if (c && c.branches && c.branches.length > 0) {
            const defOpt = document.createElement('option');
            defOpt.value = c.address;
            defOpt.text = 'المقر الرئيسي: ' + c.address;
            branchSelect.add(defOpt);
            c.branches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.address;
                opt.text = b.name + ': ' + b.address;
                branchSelect.add(opt);
            });
            branchSelect.style.display = 'block';
        }
    }

    function renderInvoicesTable() {
        const t = document.getElementById('invoicesTable'); t.innerHTML = '';
        [...data.invoices].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(i => {
            const c = data.contacts.find(x => x.id == i.contactId) || {name: 'غير محدد'};
            const typeClass = i.type==='Sales Invoice'?'success':(i.type==='Credit Note'?'danger':'warning');
            const typeName = i.type==='Sales Invoice'?'فاتورة مبيعات':(i.type==='Purchase Invoice'?'مشتريات':'مرتجع');
            
            t.innerHTML += `<tr>
                <td class="fw-bold text-primary" dir="ltr">${i.ref}</td>
                <td>${i.date}</td>
                <td class="fw-bold text-dark">${c.name}</td>
                <td><span class="badge badge-soft-${typeClass}">${typeName}</span></td>
                <td class="fw-bold" dir="ltr">${formatMoney(i.total)}</td>
                <td class="no-print">
                    <button class="btn btn-sm btn-outline-primary border" onclick="printInvoice('${i.id}', false)" title="طباعة ملونة"><i class="fa fa-print"></i></button>
                    <button class="btn btn-sm btn-outline-dark border fw-bold" onclick="printInvoice('${i.id}', true)" title="طباعة أبيض وأسود (عالي الدقة)">B&W</button>
                    <button class="btn btn-sm btn-outline-danger border" onclick="createReturn('${i.id}')" title="مرتجع"><i class="fa fa-rotate-left"></i> عكس</button>
                    <button class="btn btn-sm btn-light border text-danger ms-1" onclick="deleteInvoice('${i.key}')" title="حذف للسلة"><i class="fa fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    window.deleteInvoice = (key) => {
        if(!currentUser) return;
        if(confirm('هل أنت متأكد من حذف هذه الفاتورة؟ لن يتأثر رصيد العميل بهذا الحذف.')) {
            remove(ref(db, `users/${currentUser.uid}/invoices/${key}`)).then(() => {
                showToast('تم حذف الفاتورة');
            });
        }
    };

    window.openInvoiceModal = () => {
        currentLines = [];
        document.getElementById('invType').value = 'Sales Invoice';
        document.getElementById('invDate').value = getSaudiDateISO();
        document.getElementById('invInternalNote').value = ''; 
        $('#invContactNameSelect').val(null).trigger('change');
        $('#invContactCodeSelect').val(null).trigger('change');
        document.getElementById('invBranchAddr').style.display='none';
        const nextNum = data.invoices.length + 1; 
        document.getElementById('invRef').value = "INV-" + String(1000 + nextNum);
        renderInvLines();
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    };

    window.importInvoice = () => {
        let r = document.getElementById('importRef').value.trim();
        let target = data.invoices.find(i => i.ref === r || i.ref === "INV-" + r);
        if(!target) return alert('غير موجود');
        document.getElementById('invType').value = target.type;
        const c = data.contacts.find(x => x.id === target.contactId);
        if(c) { $('#invContactNameSelect').val(c.id).trigger('change'); }
        currentLines = [...target.lines];
        renderInvLines();
        alert('تم الاستيراد');
    };

    window.addInvLine = () => { currentLines.push({ itemId: '', qty: 1, price: 0 }); renderInvLines(); };
    window.renderInvLines = () => {
        const tb = document.getElementById('invLines'); tb.innerHTML = '';
        let sub = 0, tax = 0;
        const currentContactId = $('#invContactNameSelect').val();
        const validItems = data.items.filter(item => !item.linkedContactId || (item.linkedContactId == currentContactId));
        let itemOpts = validItems.map(x => {
            let nameDisplay = x.nameAr;
            if(x.linkedContactId) nameDisplay += ' (مخصص)'; 
            return `<option value="${x.id}">${nameDisplay}</option>`;
        }).join('');
        itemOpts = `<option value="">اختر...</option>` + itemOpts;

        currentLines.forEach((l, i) => {
            const lineTax = l.price * l.qty * 0.15;
            sub += (l.price * l.qty); tax += lineTax;
            const itemObj = data.items.find(x => x.id == l.itemId);
            const itemCode = itemObj ? itemObj.code : '-';

            tb.innerHTML += `<tr>
                <td class="bg-light text-center"><small class="fw-bold text-muted">${itemCode}</small></td>
                <td class="item-glow-container"><select class="form-select form-select-sm item-select-search" data-index="${i}">${itemOpts.replace(`value="${l.itemId}"`, `value="${l.itemId}" selected`)}</select></td>
                <td><input type="number" class="form-control form-control-sm" value="${l.price}" onchange="updLine(${i},'p',this.value)"></td>
                <td><input type="number" class="form-control form-control-sm" value="${l.qty}" onchange="updLine(${i},'q',this.value)"></td>
                <td class="text-center small text-muted" dir="ltr">${formatMoney(lineTax)}</td>
                <td class="text-center fw-bold" dir="ltr">${formatMoney((l.price*l.qty)+lineTax)}</td>
                <td class="text-center"><i class="fa fa-trash-alt text-danger" style="cursor:pointer" onclick="delLine(${i})"></i></td>
            </tr>`;
        });
        document.getElementById('invSubTotal').innerText = formatMoney(sub);
        document.getElementById('invTax').innerText = formatMoney(tax);
        document.getElementById('invGrandTotal').innerText = formatMoney(sub + tax);

        $('.item-select-search').select2({
            theme: 'bootstrap-5',
            placeholder: 'بحث عن صنف...',
            dropdownParent: $('#invoiceModal'),
            width: '100%'
        });
        
        $('.item-select-search').on('change', function() {
            const idx = $(this).data('index');
            const val = $(this).val();
            if(currentLines[idx].itemId != val) {
                updLine(idx, 'id', val);
            }
        });
    };
    window.updLine = (idx, f, v) => {
        if(f==='id') { 
            const it=data.items.find(x=>x.id==v); 
            currentLines[idx].itemId=v; 
            if(it) {
                 if(it.linkedContactId && it.specialPrice) currentLines[idx].price = Number(it.specialPrice);
                 else currentLines[idx].price = Number(it.price); 
            } else currentLines[idx].price = 0;
        }
        else if(f==='p') currentLines[idx].price=Number(v);
        else currentLines[idx].qty=Number(v);
        renderInvLines();
    };
    window.delLine = (i) => { currentLines.splice(i, 1); renderInvLines(); };

    window.saveInvoice = () => {
        const cid = $('#invContactNameSelect').val();
        if(!cid) return alert('يرجى اختيار العميل');
        if(!currentLines.length) return alert('لا توجد أصناف');
        
        const c = data.contacts.find(x=>x.id==cid);
        let finalAddress = c.address;
        const branchSelect = document.getElementById('invBranchAddr');
        if(branchSelect.style.display !== 'none' && branchSelect.value) finalAddress = branchSelect.value;

        const rawSub = parseFloat(document.getElementById('invSubTotal').innerText.replace(/,/g, ''));
        const rawTax = parseFloat(document.getElementById('invTax').innerText.replace(/,/g, ''));
        const rawTotal = parseFloat(document.getElementById('invGrandTotal').innerText.replace(/,/g, ''));
        
        const inv = {
            id: Date.now(), ref: document.getElementById('invRef').value,
            contactId: cid, type: document.getElementById('invType').value,
            date: document.getElementById('invDate').value, timestamp: getSaudiTimeISO(),
            lines: currentLines, subTotal: rawSub, tax: rawTax, total: rawTotal,
            targetAddress: finalAddress, internalNote: document.getElementById('invInternalNote').value
        };
        
        set(push(ref(db, `users/${currentUser.uid}/invoices`)), inv).then(()=>{
            bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
            showToast("تم الحفظ");
        });
    };

    window.createReturn = (id) => {
        const inv = data.invoices.find(i=>i.id==id);
        currentLines=[...inv.lines];
        document.getElementById('invType').value="Credit Note";
        const c = data.contacts.find(x => x.id === inv.contactId);
        if(c) $('#invContactNameSelect').val(c.id).trigger('change');
        document.getElementById('invDate').value=getSaudiDateISO();
        document.getElementById('invInternalNote').value = inv.internalNote || ''; 
        const nextNum = data.invoices.length + 1; 
        document.getElementById('invRef').value="RET-" + String(1000 + nextNum);
        renderInvLines();
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    };

    window.printInvoice = (id, highContrast = false) => {
        const inv = data.invoices.find(i => i.id == id);
        const c = data.contacts.find(x => x.id == inv.contactId);
        document.getElementById('pDocTitle').innerText = inv.type === 'Credit Note' ? 'إشعار دائن' : 'فاتورة ضريبية';
        document.getElementById('pRef').innerText = inv.ref;
        document.getElementById('pDate').innerText = inv.date;
        document.getElementById('pTime').innerText = new Date(inv.timestamp).toLocaleTimeString("en-GB", {timeZone: "Asia/Riyadh"}).slice(0,5);

        document.getElementById('pCompName').innerText = data.profile.businessNameAr || 'قصة خبزة - ERP';
        document.getElementById('pCompAddr').innerText = data.profile.address || '';
        document.getElementById('pCompVat').innerText = data.profile.vat || '';
        document.getElementById('pCompCR').innerText = data.profile.crNumber || ''; 
        document.getElementById('pCompPhone').innerText = data.profile.phone || '';
        document.getElementById('pCompEmail').innerText = data.profile.email || '';
        const logo = document.getElementById('pLogo');
        if(data.profile.logo) { logo.src = data.profile.logo; logo.style.display = 'block'; } else logo.style.display = 'none';

        document.getElementById('pClientName').innerText = c ? c.name : '-';
        document.getElementById('pClientAddr').innerText = inv.targetAddress ? inv.targetAddress : (c ? (c.address||'-') : '-');
        document.getElementById('pClientTax').innerText = c ? (c.taxId||'-') : '-';
        document.getElementById('pClientCR').innerText = c ? (c.crNumber||'-') : '-';

        const tb = document.getElementById('pLines'); tb.innerHTML = '';
        let totalQty = 0;
        inv.lines.forEach((l) => {
            const item = data.items.find(x => x.id == l.itemId);
            const sub = l.price * l.qty;
            const tax = sub * 0.15;
            const total = sub + tax;
            totalQty += Number(l.qty);
            tb.innerHTML += `<tr>
                <td class="center-cell">${item ? item.code : '-'}</td>
                <td style="text-align:right;">${item ? item.nameAr : '-'}</td>
                <td class="center-cell">${l.qty}</td>
                <td class="num-cell">${formatMoney(l.price)}</td>
                <td class="num-cell">${formatMoney(sub)}</td>
                <td class="center-cell">15%</td>
                <td class="num-cell">${formatMoney(tax)}</td>
                <td class="num-cell" style="font-weight:bold;">${formatMoney(total)}</td>
            </tr>`;
        });
        document.getElementById('pTotalQty').innerText = totalQty;
        document.getElementById('pSub').innerText = formatMoney(inv.subTotal);
        document.getElementById('pTax').innerText = formatMoney(inv.tax);
        document.getElementById('pTotal').innerText = formatMoney(inv.total);
        document.getElementById('qrcode').innerHTML = ""; 
        new QRCode(document.getElementById("qrcode"), { 
            text: generateZatcaBase64(data.profile.businessNameAr||'Co', data.profile.vat||'0', inv.timestamp, inv.total.toFixed(2), inv.tax.toFixed(2)), 
            width: 120, height: 120 
        });
        if(highContrast) document.body.classList.add('print-high-contrast');
        setTimeout(() => { window.print(); document.body.classList.remove('print-high-contrast'); }, 350);
    };

    window.openContactModal = () => {
        document.getElementById('contactModalTitle').innerText = 'عميل / مورد جديد';
        document.getElementById('contactFirebaseKey').value = '';
        ['cName','cPhone','cEmail','cAddr','cTax','cCR'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('cBranchesContainer').innerHTML = ''; 
        document.getElementById('cType').value='Client'; 
        generateContactCode();
        new bootstrap.Modal(document.getElementById('contactModal')).show();
    };

    window.openEditContact = (key) => {
        const c = data.contacts.find(x => x.key === key);
        if(!c) return;
        document.getElementById('contactModalTitle').innerText = 'تعديل بيانات: ' + c.name;
        document.getElementById('contactFirebaseKey').value = key;
        document.getElementById('cType').value = c.type;
        document.getElementById('cCode').value = c.code;
        document.getElementById('cName').value = c.name;
        document.getElementById('cPhone').value = c.phone || '';
        document.getElementById('cEmail').value = c.email || '';
        document.getElementById('cAddr').value = c.address || '';
        document.getElementById('cTax').value = c.taxId || '';
        document.getElementById('cCR').value = c.crNumber || '';
        const container = document.getElementById('cBranchesContainer');
        container.innerHTML = '';
        if(c.branches) c.branches.forEach(b => { addBranchInput(b.name, b.address); });
        new bootstrap.Modal(document.getElementById('contactModal')).show();
    };
    
    window.addBranchInput = (nameVal = '', addrVal = '') => {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `<input type="text" class="form-control branch-name" placeholder="اسم الفرع" value="${nameVal}"><input type="text" class="form-control branch-addr" placeholder="عنوان الفرع" value="${addrVal}"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('cBranchesContainer').appendChild(div);
    };

    window.generateContactCode = () => {
        if(document.getElementById('contactFirebaseKey').value) return;
        const t = document.getElementById('cType').value;
        const c = data.contacts.length + 1;
        document.getElementById('cCode').value = (t==='Client'?'C':'V') + String(c).padStart(5,'0');
    };

    window.saveContact = () => {
        const key = document.getElementById('contactFirebaseKey').value;
        const branches = [];
        document.querySelectorAll('#cBranchesContainer .input-group').forEach(grp => {
            const name = grp.querySelector('.branch-name').value;
            const addr = grp.querySelector('.branch-addr').value;
            if(name && addr) branches.push({name, address: addr});
        });
        const obj = {
            id: key ? data.contacts.find(x=>x.key===key).id : Date.now(), 
            code: document.getElementById('cCode').value,
            name: document.getElementById('cName').value, 
            type: document.getElementById('cType').value,
            phone: document.getElementById('cPhone').value, 
            email: document.getElementById('cEmail').value,
            address: document.getElementById('cAddr').value, 
            taxId: document.getElementById('cTax').value,
            crNumber: document.getElementById('cCR').value, 
            branches: branches
        };
        if(!obj.name) return alert('الاسم مطلوب');
        if(key) {
            update(ref(db, `users/${currentUser.uid}/contacts/${key}`), obj).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide(); 
                showToast("تم التعديل بنجاح");
            });
        } else {
            set(push(ref(db, `users/${currentUser.uid}/contacts`)), obj).then(() => {
                 bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide(); 
                 showToast("تم الحفظ بنجاح");
            });
        }
    };
    
    function renderItemsTable() { 
        const t=document.getElementById('itemsTable'); t.innerHTML=''; 
        data.items.forEach(i => {
            const linkedName = i.linkedContactId ? (data.contacts.find(c=>c.id==i.linkedContactId)?.name || 'غير موجود') : '-';
            t.innerHTML += `<tr>
                <td class="text-muted fw-bold">${i.code}</td>
                <td class="fw-bold">${i.nameAr}</td>
                <td>${i.nameEn}</td>
                <td class="text-primary fw-bold" dir="ltr">${formatMoney(i.price)}</td>
                <td class="small">${linkedName}</td>
                <td class="no-print">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditItem('${i.key}')"><i class="fa fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${i.key}')"><i class="fa fa-trash"></i></button>
                </td>
            </tr>`;
        }); 
    }

    window.openItemModal = () => { 
        document.getElementById('itemModalTitle').innerText = 'إضافة صنف';
        document.getElementById('itemFirebaseKey').value = ''; 
        document.getElementById('itemCode').value = "ITM-"+String(data.items.length+1).padStart(4,'0'); 
        document.getElementById('itemNameAr').value = ''; 
        document.getElementById('itemNameEn').value = '';
        document.getElementById('itemPrice').value = ''; 
        document.getElementById('itemLinkedContact').value = ''; 
        document.getElementById('itemSpecialPrice').value = '';
        new bootstrap.Modal(document.getElementById('itemModal')).show(); 
    };

    window.openEditItem = (key) => {
        const item = data.items.find(i => i.key === key);
        if(!item) return;
        document.getElementById('itemModalTitle').innerText = 'تعديل صنف';
        document.getElementById('itemFirebaseKey').value = key;
        document.getElementById('itemCode').value = item.code;
        document.getElementById('itemNameAr').value = item.nameAr;
        document.getElementById('itemNameEn').value = item.nameEn;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemLinkedContact').value = item.linkedContactId || '';
        document.getElementById('itemSpecialPrice').value = item.specialPrice || '';
        new bootstrap.Modal(document.getElementById('itemModal')).show();
    };

    window.saveItem = () => {
        const key = document.getElementById('itemFirebaseKey').value;
        const obj = { 
            id: key ? data.items.find(i => i.key === key).id : Date.now(),
            code: document.getElementById('itemCode').value, 
            nameAr: document.getElementById('itemNameAr').value, 
            nameEn: document.getElementById('itemNameEn').value, 
            price: Number(document.getElementById('itemPrice').value),
            linkedContactId: document.getElementById('itemLinkedContact').value,
            specialPrice: document.getElementById('itemSpecialPrice').value
        };
        if (key) {
            update(ref(db, `users/${currentUser.uid}/items/${key}`), obj).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide(); 
                showToast("تم التعديل بنجاح");
            });
        } else {
            set(push(ref(db, `users/${currentUser.uid}/items`)), obj).then(() => { 
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide(); 
                showToast("تم الحفظ بنجاح"); 
            });
        }
    };

    window.deleteItem = (key) => {
        if(!currentUser) return;
        if(confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
            remove(ref(db, `users/${currentUser.uid}/items/${key}`)).then(() => { showToast('تم الحذف بنجاح'); });
        }
    };

    window.saveSettings = () => {
        const save = (l) => {
            const d = { 
                businessNameAr: document.getElementById('setBusNameAr').value, 
                businessNameEn: document.getElementById('setBusNameEn').value,
                address: document.getElementById('setAddr').value, 
                vat: document.getElementById('setVAT').value,
                crNumber: document.getElementById('setCR').value, 
                phone: document.getElementById('setPhone').value, email: document.getElementById('setEmail').value 
            };
            if(l) d.logo = l;
            update(ref(db, `users/${currentUser.uid}/profile`), d).then(()=>showToast("تم الحفظ"));
        };
        const f = document.getElementById('logoInput').files[0];
        if(f) { const r = new FileReader(); r.onload=e=>save(e.target.result); r.readAsDataURL(f); } else save(null);
    };

    function renderContactsTable() {
        const t = document.getElementById('contactsTable'); t.innerHTML='';
        data.contacts.forEach(c => {
            const realBalance = getContactBalance(c.id);
            t.innerHTML += `
            <tr>
                <td class="text-muted fw-bold">${c.code}</td>
                <td class="fw-bold">${c.name}</td>
                <td><span class="badge bg-light text-dark border">${c.type}</span></td>
                <td>${c.phone}</td>
                <td class="${realBalance>=0?'text-success fw-bold':'text-danger fw-bold'}" dir="ltr">${formatMoney(realBalance)}</td>
                <td class="no-print">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditContact('${c.key}')"><i class="fa fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContact('${c.key}')"><i class="fa fa-trash"></i></button>
                </td>
            </tr>`
        });
    }

    window.deleteContact = (key) => { 
        if(!currentUser) return;
        if(confirm('هل أنت متأكد من حذف هذا العميل/المورد؟')) {
            remove(ref(db, `users/${currentUser.uid}/contacts/${key}`)).then(() => { showToast('تم الحذف بنجاح'); });
        }
    };

    function renderPaymentsTable() { 
        const t=document.getElementById('paymentsTable'); t.innerHTML=''; 
        data.payments.slice(-10).reverse().forEach(p=>{
            let typeName = p.type;
            if(p.type === 'Receipt') typeName = 'سند قبض';
            else if(p.type === 'Payment') typeName = 'سند صرف';
            else if(p.type === 'Adjustment') typeName = 'قيد تسوية';
            else if(p.type === 'Adjustment Reversal') typeName = 'عكس تسوية';

            // Find Contact Name
            const contact = data.contacts.find(x => x.id == p.contactId);
            const contactName = contact ? contact.name : 'محذوف';

            const displayAmount = Math.abs(Number(p.amount));

            t.innerHTML+=`
            <tr>
                <td class="text-muted small">${p.id.toString().slice(-4)}</td>
                <td>${p.date}</td>
                <td class="fw-bold">${contactName}</td>
                <td><span class="badge bg-light text-dark border">${typeName}</span></td>
                <td dir="ltr" class="text-end pe-2 fw-bold text-dark">${formatMoney(displayAmount)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-dark" onclick="reversePayment(${p.id})"><i class="fa fa-rotate-left"></i> عكس</button>
                    <button class="btn btn-sm btn-light border text-danger ms-1" onclick="deletePayment('${p.key}')" title="حذف للسلة"><i class="fa fa-trash"></i></button>
                </td>
            </tr>`; 
        }); 
    }

    window.deletePayment = (key) => {
        if(!currentUser) return;
        if(confirm('هل أنت متأكد من حذف هذا القيد؟')) {
            remove(ref(db, `users/${currentUser.uid}/payments/${key}`)).then(() => { showToast('تم حذف القيد'); });
        }
    };

    window.savePayment = () => {
        const amtVal = document.getElementById('payAmount').value;
        const noteVal = document.getElementById('payNote').value; // Get Note
        if(!amtVal) return alert('أدخل المبلغ');
        
        const p = { 
            id: Date.now(), 
            contactId: document.getElementById('payContact').value, 
            type: document.getElementById('payType').value, 
            date: document.getElementById('payDate').value, 
            amount: amtVal,
            note: noteVal // Save Note
        };
        
        if(!p.contactId) return;
        set(push(ref(db, `users/${currentUser.uid}/payments`)), p).then(()=>{ showToast("تم الحفظ"); });
    };

    window.reversePayment = (pid) => {
        if(!confirm('هل تريد عكس هذا القيد؟ سيتم إنشاء قيد جديد بقيمة معاكسة.')) return;
        const original = data.payments.find(x => x.id == pid);
        if(!original) return;
        
        let revAmount = 0;
        if(original.type === 'Receipt') {
            revAmount = Number(original.amount); 
        } else {
            revAmount = Number(original.amount) * -1; 
        }

        const p = {
            id: Date.now(),
            contactId: original.contactId,
            type: 'Adjustment Reversal',
            date: getSaudiDateISO(),
            amount: revAmount,
            note: "عكس حركة رقم: " + original.id.toString().slice(-4)
        };
        
        set(push(ref(db, `users/${currentUser.uid}/payments`)), p).then(()=>{ showToast("تم الحفظ"); });
    };

    // --- NEW: PRODUCT SALES REPORT LOGIC (DETAILED PER CLIENT) ---
    window.generateProductSales = () => {
        const d1 = document.getElementById('repProdFrom').value;
        const d2 = document.getElementById('repProdTo').value;
        if(!d1 || !d2) return alert('يرجى تحديد الفترة من وإلى');

        // Structure: { itemId: { itemObj, totalQty, totalVal, clients: { clientName: {qty, val} } } }
        const stats = {};

        data.invoices.forEach(inv => {
            if(inv.date >= d1 && inv.date <= d2) {
                let factor = 0;
                if(inv.type === 'Sales Invoice') factor = 1;
                else if(inv.type === 'Credit Note') factor = -1; 

                if(factor !== 0) {
                    const clientName = data.contacts.find(c => c.id == inv.contactId)?.name || 'عميل غير محدد';
                    
                    inv.lines.forEach(l => {
                        // Init Item
                        if(!stats[l.itemId]) {
                            stats[l.itemId] = { 
                                itemObj: data.items.find(x => x.id == l.itemId),
                                totalQty: 0, 
                                totalVal: 0,
                                clients: {}
                            };
                        }

                        // Init Client within Item
                        if(!stats[l.itemId].clients[clientName]) {
                            stats[l.itemId].clients[clientName] = { qty: 0, val: 0 };
                        }

                        const lineQty = Number(l.qty) * factor;
                        const lineVal = (Number(l.qty) * Number(l.price)) * factor;

                        // Add to Totals
                        stats[l.itemId].totalQty += lineQty;
                        stats[l.itemId].totalVal += lineVal;

                        // Add to Client
                        stats[l.itemId].clients[clientName].qty += lineQty;
                        stats[l.itemId].clients[clientName].val += lineVal;
                    });
                }
            }
        });

        const tb = document.getElementById('prodSalesTable');
        tb.innerHTML = '';
        
        Object.keys(stats).forEach(id => {
            const itemStats = stats[id];
            const item = itemStats.itemObj;
            
            if(item) {
                // 1. Render Main Item Row (Header for this item)
                tb.innerHTML += `
                <tr class="table-active">
                    <td class="fw-bold">${item.code}</td>
                    <td class="fw-bold text-primary">${item.nameAr} (الإجمالي)</td>
                    <td class="fw-bold" style="font-size:1.1rem">${itemStats.totalQty}</td>
                    <td class="fw-bold text-primary" style="font-size:1.1rem">${formatMoney(itemStats.totalVal)}</td>
                </tr>`;

                // 2. Render Client Sub-Rows
                Object.keys(itemStats.clients).forEach(clientName => {
                    const cStat = itemStats.clients[clientName];
                    if(cStat.qty !== 0) { // Only show active clients
                        tb.innerHTML += `
                        <tr style="background-color: white;">
                            <td style="border-top:none;"></td>
                            <td class="text-muted"><i class="fa fa-angle-left ms-2"></i> ${clientName}</td>
                            <td>${cStat.qty}</td>
                            <td dir="ltr">${formatMoney(cStat.val)}</td>
                        </tr>`;
                    }
                });
            }
        });
    };

    window.generateSOA = () => {
        const cid = document.getElementById('repContact').value;
        if(!cid) return;
        
        document.getElementById('soaName').innerText = data.contacts.find(x=>x.id==cid).name;
        const tb = document.getElementById('soaTable'); tb.innerHTML='';
        
        let runningBal = 0;
        let movements = [];

        data.invoices.filter(i => i.contactId == cid).forEach(x => {
            let debit = 0, credit = 0;
            if(x.type === 'Sales Invoice') { debit = x.total; }
            else { credit = x.total; } // Credit Note or Purchase
            
            let desc = `فاتورة ${x.ref}`;
            if(x.internalNote) desc += ` <br><span class="text-muted small">(${x.internalNote})</span>`;

            movements.push({ date: x.date, desc: desc, debit: debit, credit: credit, ts: new Date(x.date).getTime() });
        });

        data.payments.filter(p => p.contactId == cid).forEach(x => {
            let debit = 0, credit = 0;
            const amt = Number(x.amount);
            
            if(x.type === 'Receipt') { 
                credit = amt; 
            } else if(x.type === 'Payment') { 
                debit = amt; // Payment to vendor decreases our debt (or refund to client)
            } else {
                // Adjustment
                if(amt >= 0) debit = amt;
                else credit = Math.abs(amt);
            }

            // Correction for Payment in SOA specifically:
            if(x.type === 'Payment') {
                debit = amt; 
                credit = 0;
            }

            let typeName = x.type === 'Receipt' ? 'سند قبض' : (x.type === 'Payment' ? 'سند صرف' : 'تسوية');
            if(x.type === 'Adjustment Reversal') typeName = 'عكس قيد';
            
            let desc = `${typeName} #${x.id.toString().slice(-4)}`;
            if(x.note) desc += ` <br><span class="text-muted small fst-italic">(${x.note})</span>`;

            movements.push({ date: x.date, desc: desc, debit: debit, credit: credit, ts: new Date(x.date).getTime() });
        });

        movements.sort((a,b) => a.ts - b.ts);

        movements.forEach(m => {
            runningBal = runningBal + m.debit - m.credit;
            tb.innerHTML += `<tr>
                <td>${m.date}</td>
                <td>${m.desc}</td>
                <td class="text-danger fw-bold">${m.debit > 0 ? formatMoney(m.debit) : '-'}</td>
                <td class="text-success fw-bold">${m.credit > 0 ? formatMoney(m.credit) : '-'}</td>
                <td class="fw-bold" dir="ltr">${formatMoney(runningBal)}</td>
            </tr>`;
        });
        document.getElementById('soaResult').style.display='block';
    };
    window.printSOA = () => window.print();
    window.exportToExcel = (id, name) => XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById(id), {sheet:"Sheet1"}), name+".xlsx");

</script>
</body>
</html>
